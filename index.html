<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Marathi Crime Files</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, deleteDoc, updateDoc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// 🔥 Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCLCUAiPz-sqhFDskG9g9AwyUI1RdTQWfk",
  authDomain: "marathi-crime-files.firebaseapp.com",
  projectId: "marathi-crime-files",
  storageBucket: "marathi-crime-files.appspot.com",
  messagingSenderId: "973325762370",
  appId: "1:973325762370:web:4fb97306806bbe6cc0d2db",
  measurementId: "G-1XQPKL3740"
};

// 🔧 Initialize
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Admin Email
const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
const IMGBB_KEY = "d12c2e4a8650157b2b6b9fe85336ea43";

// 🔹 DOM
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const editor = document.getElementById("editor");
const postsArea = document.getElementById("postsArea");
const titleIn = document.getElementById("titleIn");
const catIn = document.getElementById("catIn");
const blocksList = document.getElementById("blocksList");
const publishBtn = document.getElementById("publishBtn");
const modalBg = document.getElementById("modalBg");
const modalContent = document.getElementById("modalContent");
const modalClose = document.getElementById("modalClose");

let editId = null;

// 🟢 Auth
loginBtn.onclick = async () => { await signInWithPopup(auth, new GoogleAuthProvider()); }
logoutBtn.onclick = () => signOut(auth);

auth.onAuthStateChanged(user => {
  if (user && user.email === ADMIN_EMAIL) {
    editor.classList.remove("hidden");
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
  } else {
    editor.classList.add("hidden");
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
  }
});

// 🖼 Upload to ImgBB
async function uploadToImgBB(file) {
  const fd = new FormData();
  fd.append("image", file);
  const r = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
  const d = await r.json();
  return d.data.url;
}

// ➕ Add Text/Image Block
document.getElementById("addTextBtn").onclick = () => {
  const t = document.createElement("textarea");
  t.placeholder = "लेख लिहा...";
  t.dataset.type = "text";
  t.className = "border p-2 w-full mb-2 rounded";
  blocksList.appendChild(t);
}
document.getElementById("addImageBtn").onclick = () => {
  if (blocksList.querySelectorAll('input[type="file"]').length >= 5) return alert("कमाल ५ चित्रे परवानगी!");
  const f = document.createElement("input");
  f.type = "file";
  f.dataset.type = "image";
  f.className = "w-full mb-2";
  blocksList.appendChild(f);
}

// 📰 Publish
publishBtn.onclick = async () => {
  const title = titleIn.value.trim();
  const cat = catIn.value.trim();
  if (!title) return alert("शीर्षक भरा!");

  const blocks = [];
  for (const el of blocksList.children) {
    if (el.dataset.type == "text" && el.value.trim()) blocks.push({ type: "text", text: el.value.trim() });
    if (el.type == "file" && el.files.length > 0) {
      const url = await uploadToImgBB(el.files[0]);
      blocks.push({ type: "image", url });
    }
  }

  if (blocks.length == 0) return alert("माहिती जोडा!");

  if (editId) {
    await updateDoc(doc(db, "crime_news", editId), { title, category: cat, blocks, time: Date.now() });
    editId = null;
  } else {
    await addDoc(collection(db, "crime_news"), { title, category: cat, blocks, time: Date.now() });
  }

  titleIn.value = catIn.value = "";
  blocksList.innerHTML = "";
};

// 🔍 Load Posts
onSnapshot(query(collection(db, "crime_news"), orderBy("time", "desc")), snap => {
  postsArea.innerHTML = "";
  snap.forEach(d => {
    const data = d.data();
    const img = data.blocks.find(b => b.type == "image")?.url || "https://via.placeholder.com/300x150?text=No+Image";
    const txt = data.blocks.find(b => b.type == "text")?.text.substring(0, 80) + "..." || "";
    const card = document.createElement("div");
    card.className = "bg-white shadow rounded overflow-hidden cursor-pointer hover:scale-[1.02] transition";
    card.innerHTML = `<img src="${img}" class="w-full h-40 object-cover"><div class="p-3"><h3 class="font-bold text-lg mb-1">${data.title}</h3><p class="text-sm text-gray-700">${txt}</p></div>`;
    card.onclick = () => openModal(d.id, data);
    postsArea.appendChild(card);
  });
});

// 🔎 Modal
function openModal(id, d) {
  modalContent.innerHTML = `<h2 class="font-bold text-xl mb-2">${d.title}</h2>`;
  d.blocks.forEach(b => {
    if (b.type == "text") modalContent.innerHTML += `<p class="mb-2 text-gray-800">${b.text}</p>`;
    if (b.type == "image") modalContent.innerHTML += `<img src="${b.url}" class="w-full rounded mb-2">`;
  });

  const user = auth.currentUser;
  if (user && user.email === ADMIN_EMAIL) {
    const ebtn = document.createElement("button");
    ebtn.textContent = "Edit";
    ebtn.className = "bg-gray-300 px-3 py-1 rounded mr-2";
    ebtn.onclick = () => {
      editId = id;
      titleIn.value = d.title;
      catIn.value = d.category;
      blocksList.innerHTML = "";
      d.blocks.forEach(b => {
        if (b.type == "text") {
          const t = document.createElement("textarea");
          t.value = b.text;
          t.dataset.type = "text";
          t.className = "border p-2 w-full mb-2 rounded";
          blocksList.appendChild(t);
        } else {
          const f = document.createElement("input");
          f.type = "file";
          f.dataset.type = "image";
          f.className = "w-full mb-2";
          blocksList.appendChild(f);
        }
      });
      modalBg.style.display = "none";
    };
    const dbtn = document.createElement("button");
    dbtn.textContent = "Delete";
    dbtn.className = "bg-red-500 text-white px-3 py-1 rounded";
    dbtn.onclick = async () => {
      if (confirm("पोस्ट हटवायची आहे का?")) await deleteDoc(doc(db, "crime_news", id));
      modalBg.style.display = "none";
    };
    modalContent.appendChild(ebtn);
    modalContent.appendChild(dbtn);
  }

  modalBg.style.display = "flex";
}

modalClose.onclick = () => modalBg.style.display = "none";
modalBg.onclick = e => { if (e.target === modalBg) modalBg.style.display = "none"; }
</script>

<style>
body { background: #f4f5f8; font-family: "Noto Sans Devanagari", Arial, sans-serif; }
</style>
</head>
<body class="text-gray-900">

<header class="flex justify-between items-center bg-red-800 text-white p-3 shadow sticky top-0 z-50">
  <h1 class="text-xl font-bold">Marathi Crime Files</h1>
  <div>
    <button id="loginBtn" class="bg-green-600 px-3 py-1 rounded">Login</button>
    <button id="logoutBtn" class="bg-gray-700 px-3 py-1 rounded hidden">Logout</button>
  </div>
</header>

<section id="editor" class="hidden p-4 bg-white shadow m-3 rounded">
  <h2 class="text-lg font-bold mb-2">📰 Admin Panel</h2>
  <input id="titleIn" placeholder="शीर्षक" class="border p-2 w-full mb-2 rounded">
  <input id="catIn" placeholder="वर्ग (Category)" class="border p-2 w-full mb-2 rounded">
  <div id="blocksList"></div>
  <button id="addTextBtn" class="bg-blue-600 text-white px-3 py-1 rounded mr-2">Text जोडा</button>
  <button id="addImageBtn" class="bg-blue-500 text-white px-3 py-1 rounded mr-2">Image जोडा</button>
  <button id="publishBtn" class="bg-green-700 text-white px-4 py-1 rounded">Publish</button>
</section>

<section id="postsArea" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 p-3"></section>

<div id="modalBg" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50">
  <div class="bg-white rounded-lg max-w-2xl w-11/12 max-h-[85%] overflow-y-auto p-4 relative">
    <button id="modalClose" class="absolute top-2 right-3 text-black text-xl font-bold">×</button>
    <div id="modalContent"></div>
  </div>
</div>

</body>
</html>
