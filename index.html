<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Marathi Crime Files</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, deleteDoc, updateDoc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCLCUAiPz-sqhFDskG9g9AwyUI1RdTQWfk",
  authDomain: "marathi-crime-files.firebaseapp.com",
  projectId: "marathi-crime-files",
  storageBucket: "marathi-crime-files.appspot.com",
  messagingSenderId: "973325762370",
  appId: "1:973325762370:web:4fb97306806bbe6cc0d2db",
  measurementId: "G-1XQPKL3740"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "gulistankh2011@gmail.com";
const IMGBB_API_KEY = "2387b6e1ec3474b6df29aaa462344077";

// DOM elements
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const editorArea = document.getElementById("editorArea");
const noticeEditor = document.getElementById("noticeEditor");
const postsArea = document.getElementById("postsArea");
const blocksList = document.getElementById("blocksList");
const aTitle = document.getElementById("aTitle");
const aCat = document.getElementById("aCat");
const noticeText = document.getElementById("noticeText");
const headlineText = document.getElementById("headlineText");
const modalBg = document.getElementById("modalBg");
const modalClose = document.getElementById("modalClose");
const modalContent = document.getElementById("modalContent");
const zoomModal = document.getElementById("zoomModal");
const zoomImg = document.getElementById("zoomImg");

let editingId = null;

// Auth
loginBtn.onclick = async () => { await signInWithPopup(auth, new GoogleAuthProvider()); }
logoutBtn.onclick = () => signOut(auth);

auth.onAuthStateChanged(user => {
  if (user && user.email === ADMIN_EMAIL) {
    editorArea.classList.remove("hidden");
    noticeEditor.classList.remove("hidden");
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
  } else {
    editorArea.classList.add("hidden");
    noticeEditor.classList.add("hidden");
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
  }
});

// IMGBB Upload
async function uploadToImgBB(file) {
  const formData = new FormData();
  formData.append("image", file);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
  const data = await res.json();
  return data.data.url;
}

// Add Text/Image blocks
document.getElementById("addTextBtn").onclick = () => {
  const t = document.createElement("textarea");
  t.placeholder = "Write paragraph...";
  t.dataset.type = "text";
  t.className = "border p-2 w-full mb-2 rounded";
  blocksList.appendChild(t);
}
document.getElementById("addImageBtn").onclick = () => {
  if (blocksList.querySelectorAll('input[type="file"]').length >= 10) { alert("Max 10 images allowed"); return; }
  const inp = document.createElement("input");
  inp.type = "file"; inp.dataset.type = "image"; inp.className = "w-full mb-2";
  blocksList.appendChild(inp);
}

// Publish/Update post
document.getElementById("publishBtn").onclick = async () => {
  const title = aTitle.value.trim(), cat = aCat.value.trim();
  if (!title) return alert("Enter title!");
  const blocks = [];
  for (const el of blocksList.children) {
    if (el.dataset.type == "text" && el.value.trim()) blocks.push({ type: "text", text: el.value.trim() });
    else if (el.type == "file" && el.files.length > 0) {
      const url = await uploadToImgBB(el.files[0]);
      if (url) blocks.push({ type: "image", url });
    }
  }
  if (blocks.length === 0) return alert("Add content!");
  if (editingId) {
    await updateDoc(doc(db, "vasai_news", editingId), { title, category: cat, blocks, time: Date.now() });
    editingId = null;
  } else {
    await addDoc(collection(db, "vasai_news"), { title, category: cat, blocks, time: Date.now() });
  }
  aTitle.value = aCat.value = ""; blocksList.innerHTML = "";
}

// Notice ref
const noticeRef = doc(db, "settings", "notice");
document.getElementById("saveNoticeBtn").onclick = () => setDoc(noticeRef, { text: document.getElementById("noticeInput").value.trim() });

// Load posts
onSnapshot(query(collection(db, "vasai_news"), orderBy("time", "desc")), snap => {
  const posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  postsArea.innerHTML = "";
  posts.forEach(d => {
    const img = d.blocks.find(b => b.type == "image")?.url || "https://via.placeholder.com/300x150?text=No+Image";
    const txt = d.blocks.find(b => b.type == "text")?.text.substring(0,80)+"..."||"";
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<img src='${img}' class='image-zoom'><div class='card-body'><h3>${d.title}</h3><p>${txt}</p></div>`;
    card.onclick = () => showModal(d);
    postsArea.appendChild(card);
  });
  headlineText.textContent = posts.slice(0,5).map(p=>p.title).join(" ‚Äî ");
});

// Load notice with admin edit/delete
onSnapshot(noticeRef, snap => {
  noticeText.textContent = snap.exists() ? snap.data().text : "";
  // Remove old buttons
  const oldBtns = document.getElementById("noticeBtns");
  if(oldBtns) oldBtns.remove();
  // Admin buttons
  const user = auth.currentUser;
  if(user && user.email === ADMIN_EMAIL && snap.exists()) {
    const btnDiv = document.createElement("div");
    btnDiv.id = "noticeBtns";
    btnDiv.className = "mt-2 flex gap-2";

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "bg-gray-200 px-3 py-1 rounded";
    editBtn.onclick = () => {
      const newText = prompt("Edit Notice:", snap.data().text);
      if(newText !== null) setDoc(noticeRef, { text: newText });
    }

    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.className = "bg-red-500 text-white px-3 py-1 rounded";
    delBtn.onclick = () => { if(confirm("Delete this notice?")) setDoc(noticeRef, { text: "" }); }

    btnDiv.appendChild(editBtn);
    btnDiv.appendChild(delBtn);
    noticeEditor.appendChild(btnDiv);
  }
});

// Modal for full post
modalClose.onclick = () => modalBg.style.display = "none";
modalBg.onclick = e => { if(e.target === modalBg) modalBg.style.display = "none"; }

function showModal(d) {
  modalContent.innerHTML = `<h2 class='text-lg font-bold mb-2'>${d.title}</h2>`;
  d.blocks.forEach(b => {
    if(b.type == "text") modalContent.innerHTML += `<p class='mb-2 text-gray-800'>${b.text}</p>`;
    else modalContent.innerHTML += `<img src='${b.url}' class='image-zoom'>`;
  });
  const user = auth.currentUser;
  if(user && user.email === ADMIN_EMAIL) {
    const editBtn = document.createElement("button"); editBtn.textContent="Edit"; editBtn.className="bg-gray-200 px-3 py-1 rounded mr-2";
    editBtn.onclick = () => {
      editingId = d.id; aTitle.value=d.title; aCat.value=d.category; blocksList.innerHTML="";
      d.blocks.forEach(b => {
        if(b.type=="text"){const t=document.createElement("textarea"); t.value=b.text; t.dataset.type="text"; t.className="border p-2 w-full mb-2 rounded"; blocksList.appendChild(t);}
        else {const inp=document.createElement("input"); inp.type="file"; inp.className="w-full mb-2"; blocksList.appendChild(inp);}
      });
      modalBg.style.display = "none";
    }
    const delBtn = document.createElement("button"); delBtn.textContent="Delete"; delBtn.className="bg-red-500 text-white px-3 py-1 rounded";
    delBtn.onclick = async () => { if(confirm("Delete this post?")) await deleteDoc(doc(db,"vasai_news",d.id)); modalBg.style.display="none"; }
    modalContent.appendChild(editBtn); modalContent.appendChild(delBtn);
  }

  modalBg.style.display = "flex";
  modalContent.querySelectorAll("img.image-zoom").forEach(img => img.onclick = () => { zoomImg.src = img.src; zoomModal.style.display = "flex"; });
}

document.querySelector(".zoom-close").onclick = () => zoomModal.style.display = "none";
zoomModal.onclick = e => { if(e.target === zoomModal) zoomModal.style.display = "none"; }

</script>
</head>
<body>

<header class="flex justify-between items-center p-2 bg-blue-800 text-white sticky top-0 z-50">
  <div class="flex items-center">
    <img src="https://i.postimg.cc/vTb8F94w/vasalive-png.jpg" alt="Logo" class="h-12 w-12 rounded mr-2">
    <h1 class="font-bold text-xl">Marathi Crime Files</h1>
  </div>
  <div>
    <button id="loginBtn" class="bg-green-500 px-3 py-1 rounded">Login</button>
    <button id="logoutBtn" class="hidden bg-red-500 px-3 py-1 rounded">Logout</button>
  </div>
</header>

<div class="notice-ticker bg-red-600 text-white p-1"><span id="noticeText" class="ticker-text"></span></div>
<div class="headline-ticker bg-blue-800 text-white p-1"><span id="headlineText" class="ticker-text"></span></div>

<section id="noticeEditor" class="editor hidden">
  <h2>üì∞ Admin Notice</h2>
  <input id="noticeInput" placeholder="Enter notice text..." class="w-full p-2 border rounded mb-2">
  <button id="saveNoticeBtn" class="bg-blue-700 text-white px-3 py-1 rounded">Save</button>
</section>

<section id="editorArea" class="editor hidden">
  <h2>üñãÔ∏è Admin: Create/Edit News</h2>
  <input id="aTitle" placeholder="Title" class="w-full p-2 border rounded mb-2">
  <input id="aCat" placeholder="Category" class="w-full p-2 border rounded mb-2">
  <div id="blocksList"></div>
  <button id="addTextBtn" class="bg-gray-300 px-3 py-1 rounded mr-1">Add Text</button>
  <button id="addImageBtn" class="bg-gray-300 px-3 py-1 rounded mr-1">Add Image</button>
  <button id="publishBtn" class="bg-blue-700 text-white px-3 py-1 rounded">Publish</button>
</section>

<section id="postsArea" class="posts-grid grid gap-3 p-2"></section>

<div id="modalBg" class="modal-bg flex justify-center items-center hidden">
  <div class="modal bg-white p-4 rounded max-w-lg w-11/12 max-h-[85%] overflow-y-auto relative">
    <button id="modalClose" class="modal-close absolute top-2 right-2 bg-white px-2 rounded">X</button>
    <div id="modalContent"></div>
  </div>
</div>

<div id="zoomModal" class="zoom-modal hidden fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50">
  <img id="zoomImg" src="" class="rounded shadow-lg max-w-[90%] max-h-[90%]">
  <button class="zoom-close absolute top-5 right-10 bg-white px-3 py-1 rounded">X</button>
</div>

</body>
</html>
